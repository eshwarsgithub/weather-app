<!DOCTYPE html>
<html>
<head>
    <title>Weather Activity Configuration</title>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; frame-ancestors 'self' *.marketingcloudapps.com *.exacttarget.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Salesforce Lightning Design System -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.22.2/styles/salesforce-lightning-design-system.min.css" />
    
    <style>
        body {
            background: transparent;
            font-family: 'Salesforce Sans', Arial, sans-serif;
            margin: 15px;
            padding: 0;
        }
        
        .slds-form-element {
            margin-bottom: 1rem;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .slds-text-heading_medium {
            color: #16325c;
            margin-bottom: 1rem;
        }
        
        .help-text {
            color: #696e77;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .slds-form-element__label {
            font-weight: 600;
            color: #181818;
        }
        
        .validation-error {
            color: #c23934;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        /* Fallback styles if Lightning Design System fails to load */
        .slds-form-element {
            margin-bottom: 1rem;
        }
        
        .slds-form-element__label {
            display: block;
            font-weight: 600;
            color: #181818;
            margin-bottom: 0.25rem;
        }
        
        .slds-form-element__control {
            position: relative;
        }
        
        .slds-select, .slds-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d8dde6;
            border-radius: 0.25rem;
            background-color: white;
            font-size: 0.875rem;
        }
        
        .slds-select:focus, .slds-input:focus {
            outline: 0;
            border-color: #1589ee;
            box-shadow: 0 0 0 2px #1589ee25;
        }
        
        .slds-required {
            color: #c23934;
        }
        
        .slds-box {
            padding: 1rem;
            background-color: #f3f3f3;
            border: 1px solid #d8dde6;
            border-radius: 0.25rem;
        }
        
        .slds-theme_shade {
            background-color: #f4f6f9;
        }
        
        .slds-text-heading_medium {
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1.25;
        }
        
        .slds-text-heading_small {
            font-size: 1rem;
            font-weight: 700;
            line-height: 1.25;
        }
        
        .slds-text-body_regular {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .slds-list_dotted {
            list-style-type: disc;
            margin-left: 1.5rem;
        }
        
        .slds-m-top_medium {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="slds-scope">
        <!-- Step 1: Configuration -->
        <div id="step1" class="step active">
            <h2 class="slds-text-heading_medium">Configure Weather Activity</h2>
            <p class="slds-text-body_regular">Configure how this activity will check weather conditions for your contacts.</p>
            
            <div class="slds-form-element">
                <label class="slds-form-element__label" for="location-field">
                    <abbr class="slds-required" title="required">*</abbr>
                    Location Data Field
                </label>
                <div class="slds-form-element__control">
                    <select class="slds-select" id="location-field" required>
                        <option value="">-- Select a field containing location data --</option>
                    </select>
                </div>
                <div class="help-text">
                    Select the field from your Journey entry data that contains location information.
                </div>
            </div>

            <div class="slds-form-element">
                <label class="slds-form-element__label" for="location-field-type">
                    <abbr class="slds-required" title="required">*</abbr>
                    Location Data Type
                </label>
                <div class="slds-form-element__control">
                    <select class="slds-select" id="location-field-type" required>
                        <option value="">-- Select data type --</option>
                        <option value="coordinates">Coordinates (lat,lng)</option>
                        <option value="zipcode">ZIP/Postal Code</option>
                        <option value="city">City Name</option>
                        <option value="address">Full Address</option>
                    </select>
                </div>
                <div class="help-text">
                    Specify what type of location data the selected field contains.
                </div>
            </div>

            <div class="slds-form-element">
                <label class="slds-form-element__label" for="weather-conditions">
                    Weather Conditions to Check
                </label>
                <div class="slds-form-element__control">
                    <select class="slds-select" id="weather-conditions">
                        <option value="rain,snow,storm">Rain, Snow, or Storm (Default)</option>
                        <option value="rain">Rain Only</option>
                        <option value="snow">Snow Only</option>
                        <option value="storm">Storm Only</option>
                        <option value="clear">Clear Weather</option>
                        <option value="clouds">Cloudy Weather</option>
                        <option value="custom">Custom Conditions</option>
                    </select>
                </div>
                <div class="help-text">
                    Select which weather conditions should trigger the "Adverse Weather" path.
                </div>
            </div>

            <div class="slds-form-element" id="custom-conditions-group" style="display: none;">
                <label class="slds-form-element__label" for="custom-conditions">
                    Custom Weather Conditions
                </label>
                <div class="slds-form-element__control">
                    <input type="text" class="slds-input" id="custom-conditions" 
                           placeholder="e.g., Rain,Thunderstorm,Snow" />
                </div>
                <div class="help-text">
                    Enter weather conditions separated by commas (Rain, Snow, Thunderstorm, Drizzle, etc.).
                </div>
            </div>

            <div class="slds-box slds-theme_shade slds-m-top_medium">
                <h3 class="slds-text-heading_small">Activity Outcomes</h3>
                <ul class="slds-list_dotted">
                    <li><strong>Adverse Weather:</strong> Contact experiences specified weather conditions</li>
                    <li><strong>Good Weather:</strong> Contact has clear or mild weather conditions</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Include jQuery for easier DOM manipulation -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Postmonger Library with fallback -->
    <script>
        // Try multiple CDNs for postmonger
        function loadPostmonger() {
            const postmongerUrls = [
                'https://cdn.jsdelivr.net/npm/postmonger@0.0.16/postmonger.js',
                'https://unpkg.com/postmonger@0.0.16/postmonger.js',
                'https://cdn.jsdelivr.net/npm/postmonger@latest/postmonger.js'
            ];
            
            let currentIndex = 0;
            
            function tryNextUrl() {
                if (currentIndex >= postmongerUrls.length) {
                    console.error('Failed to load postmonger from all CDNs');
                    // Create a minimal postmonger fallback
                    window.Postmonger = {
                        Session: function() {
                            return {
                                on: function() {},
                                trigger: function() {},
                                ready: function() {}
                            };
                        }
                    };
                    loadCustomActivity();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = postmongerUrls[currentIndex];
                script.onload = function() {
                    console.log('Postmonger loaded from:', postmongerUrls[currentIndex]);
                    loadCustomActivity();
                };
                script.onerror = function() {
                    console.warn('Failed to load postmonger from:', postmongerUrls[currentIndex]);
                    currentIndex++;
                    tryNextUrl();
                };
                document.head.appendChild(script);
            }
            
            tryNextUrl();
        }
        
        function loadCustomActivity() {
            const script = document.createElement('script');
            script.src = 'https://weather-app-kappa-three-25.vercel.app/customActivity.js';
            script.onload = function() {
                console.log('Custom activity loaded successfully');
            };
            script.onerror = function(e) {
                console.error('Failed to load custom activity:', e);
                // Try alternative loading method
                const fallbackScript = document.createElement('script');
                fallbackScript.innerHTML = `
                    console.log('Using fallback custom activity');
                    window.customActivityLoaded = true;
                `;
                document.head.appendChild(fallbackScript);
            };
            document.head.appendChild(script);
        }
        
        // Show/hide custom conditions input based on selection
        $(document).ready(function() {
            $('#weather-conditions').on('change', function() {
                if ($(this).val() === 'custom') {
                    $('#custom-conditions-group').show();
                } else {
                    $('#custom-conditions-group').hide();
                }
            });
            
            // Load postmonger
            loadPostmonger();
            
            console.log('Weather Activity configuration UI loaded');
            
            // Add debug information
            console.log('jQuery loaded:', typeof $ !== 'undefined');
            console.log('User Agent:', navigator.userAgent);
            console.log('Location:', window.location.href);
            console.log('Parent:', window.parent !== window ? 'In iframe' : 'Not in iframe');
            console.log('Page elements found:', {
                'location-field': $('#location-field').length,
                'location-field-type': $('#location-field-type').length,
                'weather-conditions': $('#weather-conditions').length,
                'step1': $('#step1').length
            });
            
            // Check if page is completely rendered
            if ($('#step1').length === 0) {
                console.error('Main step1 div not found! Page may not be rendering correctly.');
                // Add a fallback message
                $('body').append('<div style="padding: 20px; color: red; font-weight: bold;">ERROR: Page content not loaded. Please refresh and try again.</div>');
            }
            
            // Add a loading indicator that disappears when everything is ready
            $('body').prepend('<div id="loading-indicator" style="position: fixed; top: 0; left: 0; right: 0; background: #1589ee; color: white; text-align: center; padding: 10px; z-index: 9999;">Loading Weather Activity Configuration...</div>');
            
            setTimeout(function() {
                $('#loading-indicator').fadeOut();
            }, 2000);
        });
    </script>
</body>
</html>